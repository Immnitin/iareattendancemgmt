<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Student Dashboard</title>
  <link rel="shortcut icon" href="./images/logo.png" />
  <link href="https://fonts.googleapis.com/icon?family=Material+Icons+Sharp" rel="stylesheet" />
  <link rel="stylesheet" href="style.css" />
</head>

<body>
  <header>
    <div class="logo" title="University Management System">
      <img src="IARE-LOGO.png" alt="" />
      <h1>IARE</h1>
    </div>
    <div class="navbar">
      <a href="index.html" class="active">
        <span class="material-icons-sharp">home</span>
        <h3>Home</h3>
      </a>
      <!-- <a href="timetable.html" onclick="timeTableAll()">
          <span class="material-icons-sharp">today</span>
          <h3>Time Table</h3>
        </a> -->
      <a href="password.html">
        <span class="material-icons-sharp">password</span>
        <h3>Change Password</h3>
      </a>
      <div id="profile-btn">
        <span class="material-icons-sharp">person</span>
      </div>
      <a href="#">
        <span class="material-icons-sharp" onclick="logout()">logout</span>
        <h3 onclick="logout()">Logout</h3>
      </a>
    </div>
  </header>
  <div class="container">
    <aside>
      <div class="profile">
        <div class="top">
          <!-- Optional profile photo here -->
          <h2>Student Profile</h2>
        </div>
        <div class="about">
          <h5>
            <span class="material-icons-sharp">person_outline</span> NAME
          </h5>
          <p id="profileName"></p>

          <h5>
            <span class="material-icons-sharp">confirmation_number</span> ROLL
            NO
          </h5>
          <p id="profileRollNo"></p>

          <h5><span class="material-icons-sharp">computer</span> BRANCH</h5>
          <p id="profileBranch"></p>

          <h5><span class="material-icons-sharp">groups</span> BATCH</h5>
          <p id="profileBatch"></p>

          <h5><span class="material-icons-sharp">email</span> EMAIL</h5>
          <p id="profileEmail"></p>
        </div>
      </div>
    </aside>


    <main class="main-container responsive-layout">
      <div class="attendance-section">
        <h1>Attendance</h1>
        <div class="subjects" id="attendanceCardsContainer">
          <!-- Cards will be generated here dynamically -->
        </div>
      </div>


      <!-- card section -->
      <div class="right-section">
        <h1 class="digital-card-heading">Digital Card</h1>
        <div class="qr-card">
          <div class="qr-card-header">
            <div class="qr-card-text">
              <h3 id="cardRoll">ROLL_NO</h3>
              <p id="cardBatch">Batch: BATCH</p>
            </div>
            <div class="qr-card-photo">
              <img id="cardPhoto" src="" alt="Profile Photo" />
            </div>
          </div>
          <div class="qr-card-body">
            <img id="qrImage" alt="QR Code" />
            <p id="qrTimestamp">Generated at: --/--/---- --:--:--</p>
          </div>
          <div class="qr-card-footer">Powered by IARE</div>
        </div>
      </div>

      <!-- </div> -->
    </main>
    <!-- Spinner Overlay -->
    <div id="spinner-overlay" style="
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 9999;
">
      <div class="spinner"></div>
    </div>

  </div>
  </footer>
  <script src="app.js"></script>
  <script src="timeTable.js"></script>
  <script>
    window.addEventListener("load", () => {
      setTimeout(() => {
        document.getElementById("spinner-overlay").style.display = "none";
      }, 1000); // 1.5 seconds
    });
    function updateProfileUI(student) {
      console.log("Updating profile UI with student:", student);

      const roll = student.rollno || "N/A";
      const batch = student.batch || "N/A";

      // Profile Details
      document.getElementById("profileName").textContent = student.name || "N/A";
      document.getElementById("profileRollNo").textContent = roll;
      document.getElementById("profileBranch").textContent = student.branch || "N/A";
      document.getElementById("profileBatch").textContent = batch;
      document.getElementById("profileEmail").textContent = student.email || "N/A";

      // Card Top Text
      document.getElementById("cardRoll").textContent = `Roll No: ${roll}`;
      document.getElementById("cardBatch").textContent = `Batch: ${batch}`;

      // Profile Photo
      const photoUrl = `https://iare-data.s3.ap-south-1.amazonaws.com/uploads/STUDENTS/${roll}/${roll}.jpg`;
      document.getElementById("cardPhoto").src = photoUrl;
      document.getElementById("cardPhoto").alt = `${roll} Profile Photo`;

      // QR Code
      if (student.qrLink) {
        const qrImage = document.getElementById("qrImage");
        qrImage.src = student.qrLink;
        qrImage.alt = `${roll} QR Code`;
        qrImage.classList.add("qr-image");
      }

      // Timestamp
      const timestamp = new Date().toLocaleString();
      document.getElementById("qrTimestamp").textContent = `Generated at: ${timestamp}`;
    }

    function updateAttendanceUI(attendanceData) {
      const { overallAttendance, courseAttendance } = attendanceData;
      const container = document.getElementById("attendanceCardsContainer");
      container.innerHTML = ""; // Clear any previous cards

      // Helper to create a card
      function createCard(title, present, total, icon, colorClass = "") {
        const percent = total === 0 ? 0 : Math.round((present / total) * 100);
        const circumference = 210;
        const offset = circumference - (percent / 100) * circumference;

        const div = document.createElement("div");
        div.className = `${colorClass}`;
        div.innerHTML = `
      <span class="material-icons-sharp">${icon}</span>
      <h3>${title}</h3>
      <h2>${present}/${total}</h2>
      <div class="progress">
        <svg>
          <circle cx="38" cy="38" r="36" style="stroke-dasharray: ${circumference}; stroke-dashoffset: ${offset};"></circle>
        </svg>
        <div class="number"><p>${percent}%</p></div>
      </div>
      <small class="text-muted">Last 24 Hours</small>
    `;
        container.appendChild(div);
      }

      // Add overall attendance card
      createCard("Overall Attendance", overallAttendance.presentDays, overallAttendance.totalDays, "architecture", "eg");

      // Map for icon and color class
      const courseMeta = {
        JFS: { name: "Java FullStack Development", icon: "computer", class: "cs" },
        CP: { name: "Competitive Programming", icon: "functions", class: "mth" },
        DBMS: { name: "Database Management", icon: "storage", class: "cg" },
      };

      // Loop through each course and render
      Object.entries(courseAttendance).forEach(([key, { presentDays, totalDays }]) => {
        const meta = courseMeta[key] || {
          name: key,
          icon: "school",
          class: "net"
        };
        createCard(meta.name, presentDays, totalDays, meta.icon, meta.class);
      });
    }


    document.addEventListener("DOMContentLoaded", () => {
      if (localStorage.getItem("isLoggedIn") !== "true") {
        // Redirect to login page if not logged in
        window.location.href = "../index.html";
      }
      const rollno = localStorage.getItem("rollno");
      if (!rollno) {
        console.warn("No roll number found in localStorage.");
        return;
      }

      // Profile fetch and cache
      const cachedProfileRaw = localStorage.getItem("profileData");
      let batch = null;

      if (cachedProfileRaw) {
        try {
          const cachedProfile = JSON.parse(cachedProfileRaw);
          updateProfileUI(cachedProfile);
          batch = cachedProfile.batch || "";

          const cacheTime = localStorage.getItem("profileDataTimestamp");
          if (cacheTime && Date.now() - parseInt(cacheTime) < 3600000) {
            console.log("Using cached profile.");
          } else {
            fetch(`${backendUrl}/api/student/${encodeURIComponent(rollno)}`)
              .then(res => res.json())
              .then(data => {
                const student = data.student || data;
                localStorage.setItem("profileData", JSON.stringify(student));
                localStorage.setItem("profileDataTimestamp", Date.now().toString());
                updateProfileUI(student);
                batch = student.batch || "";
              })
              .catch(err => {
                console.error("Profile fetch error:", err);
              });
          }
        } catch (err) {
          console.error("Invalid cached profile:", err);
        }
      }

      if (!batch) {
        console.warn("Batch missing, cannot fetch attendance.");
        return;
      }
      const formattedBatch = batch
        .replace(/BATCH/gi, "")
        .replace(/\s+/g, "-")
        .replace(/-+/g, "-")
        .replace(/^-|-$/g, "")
        .toLowerCase();
      fetch(`${backendUrl}/api/facultyop/attendance?rollno=${encodeURIComponent(rollno)}&batch=${encodeURIComponent(formattedBatch)}`)
        .then((res) => {
          if (!res.ok) throw new Error("Failed to fetch attendance");
          return res.json();
        })
        .then((data) => {
          updateAttendanceUI(data);
        })
        .catch((err) => {
          console.error("Attendance fetch error:", err);
        });

    });
  </script>
  <script>
    const days = [Sunday, Monday, Tuesday, Wednesday, Thursday, Friday, Saturday];
    const dayNames = ["Sunday", "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday"];
    const today = new Date().getDay();
    let currentDayIndex = today;

    function renderTimetable(dayIndex) {
      const timetableBody = document.getElementById("timetable-body");
      if (!timetableBody) return;

      timetableBody.innerHTML = "";
      const dayData = days[dayIndex];

      dayData.forEach(row => {
        const tr = document.createElement("tr");
        tr.innerHTML = `
                <td>${row.time}</td>
                <td>${row.roomNumber}</td>
                <td>${row.subject}</td>
                <td>${row.type}</td>
            `;
        timetableBody.appendChild(tr);
      });

      document.querySelector(".timetable h2").textContent = `${dayNames[dayIndex]}'s Timetable`;
    }

    document.addEventListener("DOMContentLoaded", () => {
      renderTimetable(currentDayIndex);

      document.getElementById("prevDay")?.addEventListener("click", () => {
        currentDayIndex = (currentDayIndex - 1 + 7) % 7;
        renderTimetable(currentDayIndex);
      });

      document.getElementById("nextDay")?.addEventListener("click", () => {
        currentDayIndex = (currentDayIndex + 1) % 7;
        renderTimetable(currentDayIndex);
      });
    });

    // Timetable Data
    const Sunday = [{ time: 'Sunday', roomNumber: 'Holiday', subject: 'No class Available', type: '' }];
    const Monday = [
      { time: '09-10 AM', roomNumber: '38-718', subject: 'DBMS130', type: 'Lecture' },
      { time: '10-11 AM', roomNumber: '38-718', subject: 'MTH166', type: 'Tutorial' },
      { time: '12-01 PM', roomNumber: '38-718', subject: 'NS200', type: 'Lecture' }
    ];
    const Tuesday = [
      { time: '09-10 AM', roomNumber: '27-304Y', subject: 'MTH166', type: 'Tutorial' },
      { time: '11-12 AM', roomNumber: '28-107', subject: 'CS849', type: 'Lecture' },
      { time: '12-01 PM', roomNumber: '28-107', subject: 'CS849', type: 'Lecture' },
      { time: '02-03 PM', roomNumber: '38-718', subject: 'NS200', type: 'Lecture' }
    ];
    const Wednesday = [
      { time: '10-11 AM', roomNumber: '33-309', subject: 'DBMS130', type: 'Lecture' },
      { time: '11-12 AM', roomNumber: '38-719', subject: 'CS200', type: 'Lecture' }
    ];
    const Thursday = [
      { time: '11-12 AM', roomNumber: '33-309', subject: 'MTH166', type: 'Lecture' },
      { time: '01-02 PM', roomNumber: '38-719', subject: 'CS849', type: 'Lecture' },
      { time: '02-03 PM', roomNumber: '38-718', subject: 'NS200', type: 'Lecture' }
    ];
    const Friday = [
      { time: '10-11 AM', roomNumber: '33-309', subject: 'MEC103', type: 'Lecture' },
      { time: '11-12 AM', roomNumber: '33-309', subject: 'MEC103', type: 'Lecture' },
      { time: '02-03 PM', roomNumber: '33-601', subject: 'CS849', type: 'Tutorial' }
    ];
    const Saturday = [
      { time: '09-10 AM', roomNumber: '34-604', subject: 'DBMS130', type: 'Tutorial' },
      { time: '10-11 AM', roomNumber: '34-604', subject: 'DBMS130', type: 'Lecture' },
      { time: '01-02 PM', roomNumber: '33-309', subject: 'MTH166', type: 'Lecture' }
    ];

  </script>
</body>

</html>